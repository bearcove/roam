name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  rust-clippy:
    name: Rust / Clippy
    runs-on: depot-ubuntu-24.04-16
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install protoc
        run: sudo apt-get install -y protobuf-compiler

      - name: Clippy (xtask)
        run: cargo xtask clippy

  rust-fmt:
    name: Rust / Format
    runs-on: depot-ubuntu-24.04-4
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo xtask fmt

  rust-doc:
    name: Rust / Documentation
    runs-on: depot-ubuntu-24.04-16
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install protoc
        run: sudo apt-get install -y protobuf-compiler

      - name: Build docs (xtask)
        run: cargo xtask doc

  rust-miri:
    name: Rust / Miri
    runs-on: depot-ubuntu-24.04-16
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: miri

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Setup Miri
        run: cargo +nightly miri setup

      - name: Run Miri (shm-primitives)
        run: cargo +nightly miri test -p shm-primitives
        # Note: Miri doesn't support all libc calls, so some tests may need to be skipped
        continue-on-error: true

      - name: Run Miri (roam-shm)
        run: cargo +nightly miri test -p roam-shm
        continue-on-error: true

  rust-loom:
    name: Rust / Loom
    runs-on: depot-ubuntu-24.04-16
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run loom tests
        run: cargo nextest run --profile loom -p shm-primitives
        env:
          RUSTFLAGS: "--cfg loom"

  rust-conformance:
    name: Conformance / Rust
    runs-on: depot-ubuntu-24.04-16
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build subject
        run: cargo build -p subject-rust

      - name: Run Rust TCP subject matrix tests
        run: >
          cargo nextest run -p spec-tests --test spec_matrix
          -E 'test(lang_rust_transport_tcp_direction_harness_to_subject_rpc_echo_roundtrip)
          | test(lang_rust_transport_tcp_direction_harness_to_subject_rpc_user_error_roundtrip)
          | test(lang_rust_transport_tcp_direction_harness_to_subject_rpc_pipelining_multiple_requests)
          | test(lang_rust_transport_tcp_direction_subject_to_harness_channeling_sum_client_to_server)
          | test(lang_rust_transport_tcp_direction_harness_to_subject_channeling_generate_server_to_client)
          | test(lang_rust_transport_tcp_direction_bidirectional_channeling_transform)
          | test(lang_rust_transport_tcp_direction_harness_to_subject_binary_payload_sizes)'

      - name: Run Rust binary payload transport matrix (mem/tcp/shm)
        run: >
          cargo nextest run -p spec-tests --test spec_matrix
          -E 'test(lang_rust_to_rust_transport_mem_direction_bidirectional_binary_payload_transport_matrix)
          | test(lang_rust_to_rust_transport_tcp_direction_bidirectional_binary_payload_transport_matrix)
          | test(lang_rust_to_rust_transport_shm_direction_bidirectional_binary_payload_transport_matrix)'

  generated-bindings:
    name: Generated / Bindings Sync
    runs-on: depot-ubuntu-24.04-4
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Regenerate TypeScript and Swift bindings
        run: cargo xtask codegen --typescript --swift

      - name: Check generated bindings are committed
        run: |
          DRIFT="$(git status --porcelain -- typescript/generated swift/subject/Sources/subject-swift)"
          if [ -n "$DRIFT" ]; then
            echo "Generated bindings are out of date. Run: cargo xtask codegen --typescript --swift"
            echo "$DRIFT"
            git --no-pager diff -- typescript/generated swift/subject/Sources/subject-swift || true
            exit 1
          fi

  typescript-conformance:
    name: Conformance / TypeScript
    runs-on: depot-ubuntu-24.04-4
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '25'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install TypeScript dependencies
        run: cd typescript && pnpm install

      - name: TypeScript typecheck (tsgo)
        run: cd typescript && pnpm check

      - name: Generate TypeScript bindings
        run: cargo xtask codegen --typescript

      - name: Install Playwright browsers
        run: cd typescript && pnpm exec playwright install --with-deps chromium

      - name: Run TypeScript tests
        run: cd typescript && pnpm test

      - name: Run TypeScript TCP subject matrix tests
        run: >
          cargo nextest run -p spec-tests --test spec_matrix
          -E 'test(lang_typescript_transport_tcp_direction_harness_to_subject_rpc_echo_roundtrip)
          | test(lang_typescript_transport_tcp_direction_harness_to_subject_rpc_user_error_roundtrip)
          | test(lang_typescript_transport_tcp_direction_harness_to_subject_rpc_pipelining_multiple_requests)
          | test(lang_typescript_transport_tcp_direction_subject_to_harness_channeling_sum_client_to_server)
          | test(lang_typescript_transport_tcp_direction_harness_to_subject_channeling_generate_server_to_client)
          | test(lang_typescript_transport_tcp_direction_bidirectional_channeling_transform)
          | test(lang_typescript_transport_tcp_direction_harness_to_subject_binary_payload_sizes)'

  swift-conformance:
    name: Conformance / Swift
    runs-on: depot-macos-15
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build Rust FFI staticlib
        run: cargo build --release -p roam-shm-ffi

      - name: Build subject
        run: swift build -c release --package-path swift/subject

      - name: Run RoamRuntime Swift tests
        run: swift test --no-parallel -Xlinker -L$(pwd)/target/release

      - name: Build Swift shm-guest-client
        run: swift build -c debug --package-path swift/roam-runtime --product shm-guest-client

      - name: Run SHM cross-language guest regression tests (via spec-tests)
        run: >
          cargo nextest run -p spec-tests --test spec_matrix
          -E 'test(lang_swift_to_rust_transport_shm_direction_guest_to_host_cross_language_data_path)
          | test(lang_swift_to_rust_transport_shm_direction_guest_to_host_cross_language_message_v7)
          | test(lang_rust_to_swift_transport_shm_direction_host_to_guest_cross_language_mmap_ref_receive)'

      - name: Run Swift TCP subject matrix tests
        run: >
          cargo nextest run -p spec-tests --test spec_matrix
          -E 'test(lang_swift_transport_tcp_direction_harness_to_subject_rpc_echo_roundtrip)
          | test(lang_swift_transport_tcp_direction_harness_to_subject_rpc_user_error_roundtrip)
          | test(lang_swift_transport_tcp_direction_harness_to_subject_rpc_pipelining_multiple_requests)
          | test(lang_swift_transport_tcp_direction_subject_to_harness_channeling_sum_client_to_server)
          | test(lang_swift_transport_tcp_direction_harness_to_subject_channeling_generate_server_to_client)
          | test(lang_swift_transport_tcp_direction_bidirectional_channeling_transform)
          | test(lang_swift_transport_tcp_direction_harness_to_subject_binary_payload_sizes)'

      - name: Run binary payload subject test (Swift over SHM)
        run: >
          cargo nextest run -p spec-tests --test spec_matrix
          -E 'test(lang_swift_transport_shm_direction_harness_to_subject_binary_payload_sizes_guest_mode)
          | test(lang_swift_transport_shm_direction_harness_to_subject_binary_payload_cutover_boundaries_guest_mode)'

      - name: Run binary payload subject test (Swift over SHM host-direction)
        run: >
          cargo nextest run -p spec-tests --test spec_matrix
          -E 'test(lang_swift_transport_shm_direction_harness_to_subject_binary_payload_sizes_host_mode)
          | test(lang_swift_transport_shm_direction_harness_to_subject_binary_payload_cutover_boundaries_host_mode)'

  swift-linux:
    name: Conformance / Swift (Linux)
    runs-on: depot-ubuntu-24.04-16
    steps:
      - uses: actions/checkout@v6

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.0"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build Rust FFI staticlib
        run: cargo build --release -p roam-shm-ffi

      - name: Build subject
        run: swift build -c release --package-path swift/subject

      - name: Run RoamRuntime Swift tests
        run: swift test --no-parallel -Xlinker -L$(pwd)/target/release

      - name: Run Swift TCP subject matrix tests
        run: >
          cargo nextest run -p spec-tests --test spec_matrix
          -E 'test(lang_swift_transport_tcp_direction_harness_to_subject_rpc_echo_roundtrip)
          | test(lang_swift_transport_tcp_direction_harness_to_subject_rpc_user_error_roundtrip)
          | test(lang_swift_transport_tcp_direction_harness_to_subject_rpc_pipelining_multiple_requests)
          | test(lang_swift_transport_tcp_direction_subject_to_harness_channeling_sum_client_to_server)
          | test(lang_swift_transport_tcp_direction_harness_to_subject_channeling_generate_server_to_client)
          | test(lang_swift_transport_tcp_direction_bidirectional_channeling_transform)
          | test(lang_swift_transport_tcp_direction_harness_to_subject_binary_payload_sizes)'

      - name: Run binary payload subject test (Swift over SHM)
        run: >
          cargo nextest run -p spec-tests --test spec_matrix
          -E 'test(lang_swift_transport_shm_direction_harness_to_subject_binary_payload_sizes_guest_mode)
          | test(lang_swift_transport_shm_direction_harness_to_subject_binary_payload_cutover_boundaries_guest_mode)'

  rust-wasm:
    name: Rust / WebAssembly
    runs-on: depot-ubuntu-24.04-4
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Check roam-websocket for wasm32
        run: cargo check --target wasm32-unknown-unknown -p roam-websocket

      - name: Check wasm-browser-tests for wasm32
        run: cargo check --target wasm32-unknown-unknown -p wasm-browser-tests

  wasm-browser-tests:
    name: Browser / Rust-Wasm
    runs-on: depot-ubuntu-24.04-4
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '25'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Build wasm-browser-tests
        run: wasm-pack build --target web rust/wasm-browser-tests --out-dir ../../typescript/tests/browser-wasm/pkg

      - name: Install TypeScript dependencies
        run: cd typescript && pnpm install

      - name: Install Playwright browsers
        run: cd typescript && pnpm exec playwright install --with-deps chromium

      - name: Run Wasm browser tests
        run: cd typescript/tests/playwright && pnpm exec playwright test wasm.spec.ts

  # rust-windows:
  #   name: Rust / Windows
  #   runs-on: depot-windows-2025-16
  #   steps:
  #     - uses: actions/checkout@v6
  #
  #     - name: Install Rust
  #       uses: dtolnay/rust-toolchain@stable
  #
  #     - name: Cache cargo
  #       uses: Swatinem/rust-cache@v2
  #
  #     - name: Test shm-primitives
  #       run: cargo test -p shm-primitives
  #
  #     - name: Test roam-shm
  #       run: cargo test -p roam-shm
