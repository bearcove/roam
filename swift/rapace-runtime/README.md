# Rapace Runtime for Swift

Core runtime library for Rapace RPC services in Swift.

## Architecture

This package provides the **core runtime components** that are common across all Rapace services. Service-specific code (method IDs, client stubs, dispatch logic) should be **generated by codegen**, not hand-written.

This follows the same design as:
- **Rust**: `rapace-session` crate with `UnaryCaller` trait
- **TypeScript**: `@bearcove/rapace-runtime` with `UnaryDispatcher<H>`

## Components

### Binary Encoding (`Varint.swift`, `COBS.swift`)
- LEB128 varint encoding/decoding
- COBS (Consistent Overhead Byte Stuffing) framing
- Core primitives used by the wire protocol

### Postcard Serialization (`Postcard.swift`)
- String/bytes encoding/decoding
- Result type encoding for RPC responses
- Error encoding (UnknownMethod, InvalidPayload, etc.)

### RPC Dispatch (`Dispatcher.swift`)

**Server-side**: `UnaryDispatcher<Service>`
```swift
let dispatcher = UnaryDispatcher(methodHandlers: [
    0x1234: { service, payload in
        // Codegen provides this handler
        // Decode args, call method, encode result
    }
])

let response = await dispatcher.dispatch(
    service: myService,
    methodId: methodId,
    payload: requestPayload
)
```

**Client-side**: `UnaryCaller` protocol
```swift
// Codegen creates client stubs that use any UnaryCaller implementation:
class MyClient<Caller: UnaryCaller> {
    let caller: Caller

    func myMethod(arg: String) async throws -> Int {
        let payload = encodeArgs(arg)  // codegen
        let response = try await caller.callUnary(methodId: 0x1234, payload: payload)
        return decodeResponse(response)  // codegen
    }
}
```

### Error Types (`Errors.swift`)
- `RapaceError`: Runtime errors (decode, encode, transport)
- `CallError<UserError>`: RPC call results (user error or protocol error)

## What Codegen Should Generate

For each service trait:
1. **Method IDs**: Computed from service/method names and signatures
2. **Dispatch map**: `[UInt64: MethodHandler<Service>]` mapping IDs to handlers
3. **Client struct**: Generic over `UnaryCaller`, with typed methods
4. **Encoding/decoding**: Service-specific postcard serialization

## Testing

```bash
swift test
```

## Usage

Add as a dependency in your `Package.swift`:

```swift
dependencies: [
    .package(path: "../rapace-runtime")
],
targets: [
    .target(
        name: "MyService",
        dependencies: [
            .product(name: "RapaceRuntime", package: "rapace-runtime")
        ]
    )
]
```
